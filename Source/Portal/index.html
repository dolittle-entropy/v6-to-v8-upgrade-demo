<!DOCTYPE html>
<html>
    <head>
        <style>
            p#result {
                color: green;
                display: none;
            }
            p#error {
                color: red;
                display: none;
            }
            thead {
                font-weight: bold;
            }
            tbody tr td:nth-child(2) {
                text-align: right;
            }
            tbody tr td:nth-child(3) {
                text-align: right;
            }
            form > p > input#customer {
                width: 20em;
            }
        </style>
        <script>
            function stringIsEmpty(value) {
                return value === undefined || value === null || value.trim().length === 0;
            }

            function updateCustomerTable() {
                const table = document.querySelector('tbody#customers');
                fetch('/orders/customerorders/')
                    .then(response => response.json())
                    .then(customers => {
                        table.replaceChildren();
                        for (const customer in customers) {
                            const { TotalSpending, OrdersPlaced, Status } = customers[customer];
                            const row = document.createElement('tr');
                            row.appendChild(document.createElement('td')).innerText = customer;
                            row.appendChild(document.createElement('td')).innerText = TotalSpending;
                            row.appendChild(document.createElement('td')).innerText = OrdersPlaced;
                            row.appendChild(document.createElement('td')).innerText = Status;
                            const button = document.createElement('button');
                            button.innerText = 'Use';
                            button.onclick = (event) => {
                                event.preventDefault();
                                const form = document.querySelector('form');
                                form.querySelector('input#customer').value = customer;
                            };
                            row.appendChild(document.createElement('td').appendChild(button));
                            table.appendChild(row);
                        }
                    })
                    .then(() => {
                        setTimeout(updateCustomerTable, 100);
                    })
            }

            function generateGUID(event) {
                event.preventDefault();

                const form = event.target.parentElement.parentElement;
                form.querySelector('input#customer').value = crypto.randomUUID();
            }

            async function submitTheForm(event) {
                event.preventDefault();
                
                const form = event.target;
                const result = form.querySelector('p#result');
                const warning = form.querySelector('p#error');
                result.style.display = 'none';
                warning.style.display = 'none';

                try
                {
                    const action =
                        form.querySelector('input#action-order').checked ? 'order' : 
                        form.querySelector('input#action-pay').checked ? 'pay' :
                        undefined;
                    if (!action) {
                        throw new Error('No action selected');
                    }

                    const customerID = form.querySelector('input#customer').value;
                    if (stringIsEmpty(customerID)) {
                        throw new Error('No customer specified');
                    }
                    
                    const amount = form.querySelector('input#amount').value;
                    if (stringIsEmpty(amount)) {
                        throw new Error('Please specify an amount');
                    }

                    const response = await fetch(`http://localhost:8000/orders/customerorders/${action}?customer=${customerID}&amount=${amount}`, { method: 'POST' });
                    if (response.ok) {
                        result.innerText = `${action} successful! ðŸ’¸`;
                        result.style.display = 'initial';
                    } else {
                        throw new Error(await response.text());
                    }
                }
                catch (error)
                {
                    warning.innerText = error.message;
                    warning.style.display = 'initial';
                }
            }
        </script>
    </head>
    <body onload="updateCustomerTable()">
        <h1>Dolittle Demo Purchase Orders</h1>
        <form onsubmit="submitTheForm(event)">
            <p>
                <input type="radio" id="action-order" name="action" value="order" checked />
                <label for="action-order">Order</label>
                <input type="radio" id="action-pay" name="action" value="pay" />
                <label for="action-pay">Pay</label>

                <input type="text" id="customer" name="customer" placeholder="Customer ID">
                <button onclick="generateGUID(event)">Generate</button>
                
                <input type="text" id="amount" name="amount" placeholder="1000">
                
                <input type="submit" value="Send away!">
            </p>
            <p id="result">Result</p>
            <p id="error">Error</p>
        </form>

        <h2>Customers:</h2>
        <table>
            <thead>
                <td>Customer:</td>
                <td>Spent money:</td>
                <td># Orders:</td>
                <td>Status:</td>
                <td></td>
            </thead>
            <tbody id="customers">
            </tbody>
        </table>
    </body>
</html>